#!/usr/bin/env bash

#  Copyright 2012-2016 Stanislav Senotrusov <stan@senotrusov.com>
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

if [ -n "${VERBOSE:-}" ]; then
  set -o xtrace
fi

set -o nounset

. deploy-lib.sh || { echo "Unable to load deploy-lib.sh" >&2; exit 1; }
. config.sh || fail "Unable to load config.sh"

. data-pi/data-pi-lib.sh || fail "Unable to load data-pi/data-pi-lib.sh"
. sublime/sublime-lib.sh || fail "Unable to load sublime/sublime-lib.sh"
. sway/sway-lib.sh || fail "Unable to load ubuntu/sway.sh"
. ubuntu/ubuntu-lib.sh || fail "Unable to load ubuntu/ubuntu-lib.sh"
. ubuntu/ubuntu-packages.sh || fail "Unable to load ubuntu/ubuntu-packages.sh"
. vscode/vscode-lib.sh || fail "Unable to load vscode/vscode-lib.sh"

ubuntu::deploy-workstation::as-root() {
  if [ -n "${VERBOSE:-}" ]; then
    set -o xtrace
  fi

  # System configuration
  ubuntu::set-inotify-max-user-watches || fail

  # Update the system
  apt::update || fail
  apt::perhaps-install-mbpfan || fail
  apt::dist-upgrade || fail

  # Install packages
  apt::install-basic-tools || fail
  apt::install-ruby-and-devtools || fail
  apt::install-workstation-tools || fail
  apt::install-dconf || fail

  # meld is not working properly in sway
  if [ -z "${DEPLOY_SWAY:-}" ]; then
    apt::install-meld || fail
  fi

  # Compile libsecret
  ubuntu::compile-git-credential-libsecret || fail

  # IMWhell for GNOME and XFCE
  if [ "${DESKTOP_SESSION:-}" = "ubuntu" ] || [ "${DESKTOP_SESSION:-}" = "ubuntu-wayland" ] || [ "${DESKTOP_SESSION:-}" = "xubuntu" ]; then
    apt::install-imwhell || fail
  fi

  # Some stuff for XFCE
  if [ "${DESKTOP_SESSION:-}" = "xubuntu" ]; then
    apt::install-xfce-related-packages || fail
  fi

  # If I have enough RAM then I could use some extra packages
  if [ "${DEPLOY_LEAN_WORKSTATION:-}" != "true" ]; then
    apt::install-tor || fail
    apt::install-ffmpeg || fail
    if ubuntu::bare-metal; then  
      apt::install-obs-studio || fail
    fi
  fi

  # open-vm-tools
  apt::perhaps-install-open-vm-tools-desktop || fail

  # Add extra apt sources
  apt::add-yarn-source || fail
  apt::add-nodejs-source || fail
  sublime::apt::add-sublime-source || fail
  if ubuntu::bare-metal; then
    apt::add-syncthing-source || fail
  fi
  apt::update || fail

  # Instal packages from previously added sources
  apt::install-nodejs-and-yarn || fail
  sublime::apt::install-sublime-merge || fail
  sublime::apt::install-sublime-text || fail
  if ubuntu::bare-metal; then
    apt::install-syncthing || fail
    sudo systemctl enable --now "syncthing@${SUDO_USER}.service" || fail
  fi

  # apt cleanup
  apt::autoremove || fail

  # Snap packages
  vscode::snap::install || fail
  snap::install-bitwarden-cli || fail
  snap::install-workstation-tools || fail
  if ubuntu::bare-metal; then
    snap::install-productivity-workstation-tools || fail
  fi

  # Add hgfs automount if needed
  ubuntu::perhaps-add-hgfs-automount || fail

  # Setup gnome keyring to load for text consoles
  ubuntu::setup-gnome-keyring-pam || fail
}

ubuntu::deploy-workstation::as-user() {
  # Desktop configuration
  ubuntu::configure-desktop-apps || fail

  # Remove user dirs
  ubuntu::remove-user-dirs || fail

  # symlink hgfs mounts
  ubuntu::symlink-hgfs-mounts || fail

  # IMWhell for GNOME and XFCE
  if [ "${DESKTOP_SESSION:-}" = "ubuntu" ] || [ "${DESKTOP_SESSION:-}" = "ubuntu-wayland" ] || [ "${DESKTOP_SESSION:-}" = "xubuntu" ]; then
    ubuntu::setup-imwhell || fail
  fi

  # XFCE-specific
  if [ "${DESKTOP_SESSION:-}" = "xubuntu" ]; then
    ubuntu::setup-super-key-to-xfce-menu-workaround || fail
  fi

  # Shell aliases
  ubuntu::install-bashrcd || fail
  ubuntu::install-bashrcd::use-nano-editor || fail
  ubuntu::install-bashrcd::my-computer-deploy-shell-alias || fail
  ubuntu::install-bashrcd::gnome-keyring-daemon-start || fail # SSH agent init for text console logins
  data-pi::install-bashrcd::shell-aliases || fail

  # Editors
  vscode::install-config || fail
  vscode::install-extensions || fail
  sublime::install-config || fail

  # SSH keys
  ubuntu::install-ssh-keys || fail

  # Git
  ubuntu::configure-git || fail

  # Install sway
  if [ -n "${DEPLOY_SWAY:-}" ]; then
    sway::install || fail
    sway::install-config || fail
    sway::install-bashrcd || fail
  fi
}

ubuntu::deploy-workstation() {
  deploy-lib::footnotes::init || fail
  sway::determine-conditional-install-flag || fail

  ubuntu::detect-lean-workstation || fail

  sudo --preserve-env="DESKTOP_SESSION,XDG_SESSION_TYPE,VERBOSE,DEPLOY_FOOTNOTES,DEPLOY_SWAY,DEPLOY_LEAN_WORKSTATION" bash -c "set -o nounset; $(declare -f); ubuntu::deploy-workstation::as-root" || fail "Unable to execute ubuntu::deploy-workstation::as-root ($?)"

  ubuntu::deploy-workstation::as-user || fail

  if [ -x /usr/lib/update-notifier/update-motd-reboot-required ]; then
    /usr/lib/update-notifier/update-motd-reboot-required >> "${DEPLOY_FOOTNOTES}" || fail
  fi

  deploy-lib::footnotes::flush || fail

  echo "ubuntu::deploy-workstation completed"
}

"${1:-ubuntu::deploy-workstation}" "${@:2}" || fail
