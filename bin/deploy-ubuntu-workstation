#!/usr/bin/env bash

#  Copyright 2012-2016 Stanislav Senotrusov <stan@senotrusov.com>
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

set -o xtrace
set -o nounset

. deploy-lib.sh || { echo "Unable to load deploy-lib.sh" >&2; exit 1; }
. config.sh || fail "Unable to load config.sh"
. data-pi/data-pi-lib.sh || fail "Unable to load data-pi/data-pi-lib.sh"
. sublime/sublime-lib.sh || fail "Unable to load sublime/sublime-lib.sh"
. ubuntu/ubuntu-lib.sh || fail "Unable to load ubuntu/ubuntu-lib.sh"
. ubuntu/ubuntu-packages.sh || fail "Unable to load ubuntu/ubuntu-packages.sh"
. vscode/vscode-lib.sh || fail "Unable to load vscode/vscode-lib.sh"

ubuntu::deploy-workstation::as-root() {
  # System configuration
  ubuntu::set-inotify-max-user-watches || fail

  # Update the system
  apt::update || fail
  apt::perhaps-install-mbpfan || fail
  apt::dist-upgrade || fail

  # Install packages
  apt::install-basic-tools || fail
  apt::install-ruby-and-devtools || fail
  apt::install-dconf || fail
  # IMWhell for GNOME and XFCE
  if [ "${DESKTOP_SESSION:-}" = "ubuntu" ] || [ "${DESKTOP_SESSION:-}" = "ubuntu-wayland" ] || [ "${DESKTOP_SESSION:-}" = "xubuntu" ]; then
    apt::install-imwhell || fail
  fi
  apt::install-workstation-tools || fail
  if [ "${DESKTOP_SESSION:-}" = "xubuntu" ]; then
    apt::install-xfce-related-packages || fail
  fi
  ubuntu::install-git-credential-libsecret || fail

  if [ "${LEAN_WORKSTATION:-}" != "true" ]; then
    apt::install-tor || fail
    apt::install-ffmpeg || fail
    if ubuntu::bare-metal; then  
      apt::install-obs-studio || fail
    fi
  fi

  snap::install-bitwarden-cli || fail
  snap::install-workstation-tools || fail
  if ubuntu::bare-metal; then
    snap::install-productivity-workstation-tools || fail
  fi

  # Add extra apt sources
  apt::add-yarn-source || fail
  apt::add-nodejs-source || fail
  sublime::apt::add-sublime-source || fail
  if ubuntu::bare-metal; then
    apt::add-syncthing-source || fail
  fi
  apt::update || fail

  # Instal packages from previously added sources
  apt::install-nodejs-and-yarn || fail
  sublime::apt::install-sublime-merge || fail
  sublime::apt::install-sublime-text || fail
  if ubuntu::bare-metal; then
    apt::install-syncthing || fail
    sudo systemctl enable --now "syncthing@${SUDO_USER}.service" || fail
  fi

  # Install vscode
  vscode::snap::install || fail

  # Cleanup
  apt::autoremove || fail

  # Add hgfs automount if needed
  ubuntu::perhaps-add-hgfs-automount || fail
}

ubuntu::deploy-workstation::as-user() {
  # Desktop configuration
  ubuntu::configure-desktop-apps || fail

  # Editors
  vscode::install-config || fail
  vscode::install-extensions || fail
  sublime::install-config || fail

  # Shell aliases
  ubuntu::install-bashrcd || fail
  ubuntu::install-my-computer-deploy-shell-alias || fail
  data-pi::install-shell-aliases || fail

  # SSH keys
  ubuntu::install-ssh-keys || fail

  # Git
  ubuntu::configure-git || fail

  # Remove user dirs
  ubuntu::remove-user-dirs || fail

  # symlink hgfs mounts
  ubuntu::symlink-hgfs-mounts || fail

  # IMWhell for GNOME and XFCE
  if [ "${DESKTOP_SESSION:-}" = "ubuntu" ] || [ "${DESKTOP_SESSION:-}" = "ubuntu-wayland" ] || [ "${DESKTOP_SESSION:-}" = "xubuntu" ]; then
    ubuntu::setup-imwhell || fail
  fi

  # XFCE-specific
  if [ "${DESKTOP_SESSION:-}" = "xubuntu" ]; then
    ubuntu::setup-super-key-to-xfce-menu-workaround || fail
  fi
}

ubuntu::deploy-workstation() {
  DEPLOY_FOOTNOTES="$(mktemp)" || fail "Unable to create temp file"
  export DEPLOY_FOOTNOTES

  ubuntu::detect-lean-workstation || fail

  sudo --preserve-env="LEAN_WORKSTATION,DEPLOY_FOOTNOTES,DESKTOP_SESSION" bash -c "set -o xtrace; set -o nounset; $(declare -f); ubuntu::deploy-workstation::as-root" || fail "Unable to execute ubuntu::deploy-workstation::as-root ($?)"

  ubuntu::deploy-workstation::as-user || fail

  if [ -s "${DEPLOY_FOOTNOTES}" ]; then
    echo "ubuntu::deploy-workstation completed with the following notes:"
    cat "${DEPLOY_FOOTNOTES}"
  else
    echo "ubuntu::deploy-workstation completed"
  fi
}

"${1:-ubuntu::deploy-workstation}" "${@:2}" || fail
